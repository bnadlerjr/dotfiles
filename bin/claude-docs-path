#!/bin/bash
# claude-docs-path: Resolve the Claude docs directory for the current project
#
# Usage:
#   claude-docs-path              # Returns full docs path
#   claude-docs-path plans        # Returns plans subdirectory
#   claude-docs-path research     # Returns research subdirectory
#   claude-docs-path tickets      # Returns tickets subdirectory
#   claude-docs-path architecture # Returns architecture subdirectory
#   claude-docs-path handoffs     # Returns handoffs subdirectory
#
# Environment:
#   CLAUDE_DOCS_ROOT - Base directory for Claude docs (e.g., ~/Dropbox/Obsidian/Vault/Claude/Projects)
#                      If unset, falls back to .claude/docs (project-local)
#
# Examples:
#   $ export CLAUDE_DOCS_ROOT=~/Dropbox/Obsidian/Vault/Claude/Projects
#   $ cd ~/code/myapp
#   $ claude-docs-path
#   /Users/bob/Dropbox/Obsidian/Vault/Claude/Projects/myapp
#   $ claude-docs-path plans
#   /Users/bob/Dropbox/Obsidian/Vault/Claude/Projects/myapp/plans

set -euo pipefail

SUBDIR="${1:-}"

# Detect project name from git root
get_project_name() {
    local git_root
    git_root="$(git rev-parse --show-toplevel 2>/dev/null)" || {
        echo "unknown-project"
        return
    }
    basename "$git_root"
}

# Resolve the docs path
resolve_docs_path() {
    if [[ -n "${CLAUDE_DOCS_ROOT:-}" ]]; then
        # External docs root - namespace by project
        local project
        project="$(get_project_name)"
        # Expand ~ if present
        local expanded_root="${CLAUDE_DOCS_ROOT/#\~/$HOME}"
        echo "${expanded_root}/${project}"
    else
        # Fall back to project-local .claude/docs
        local git_root
        git_root="$(git rev-parse --show-toplevel 2>/dev/null)" || git_root="."
        echo "${git_root}/.claude/docs"
    fi
}

DOCS_PATH="$(resolve_docs_path)"

# Ensure directory exists
mkdir -p "$DOCS_PATH"

# Append subdirectory if specified
if [[ -n "$SUBDIR" ]]; then
    DOCS_PATH="${DOCS_PATH}/${SUBDIR}"
    mkdir -p "$DOCS_PATH"
fi

echo "$DOCS_PATH"
